# 修复验证清单

## 已修复的问题

### 1. ✅ 目标值统一为分钟数输入

**实现方式：**
- 时长类型：直接输入分钟数（如：240 表示 4小时）
- 次数类型：直接输入次数（如：3）
- 时刻类型：输入4位数字（如：0800 表示 8:00），内部转换为分钟数

**验证步骤：**
1. 打开自动日课配置对话框
2. 选择"总时长"类型
3. 输入 240，应该显示"当前设置：240分钟（4小时）"
4. 选择"最早开始时间"类型
5. 输入 0800，应该显示"当前设置：08:00（480分钟）"
6. 选择"次数"类型
7. 输入 3，应该显示"当前设置：3次"

**代码位置：**
- `src/components/AutoCheckItemEditor.tsx` 第 240-260 行
- 所有类型统一使用 `targetValue: number`（分钟数）

---

### 2. ✅ 修复模态框点击关闭的问题

**问题原因：**
- 输入框的点击事件冒泡到模态框背景层，触发关闭

**解决方案：**
- 在所有输入框的 `onChange` 和 `onClick` 事件中添加 `e.stopPropagation()`
- 在模态框内容区域添加 `onClick={(e) => e.stopPropagation()}`
- 只有点击背景层才会关闭模态框

**验证步骤：**
1. 打开自动日课配置对话框
2. 点击"日课名称"输入框
3. 输入文字，模态框不应该关闭
4. 点击"筛选条件"输入框
5. 输入文字，模态框不应该关闭
6. 点击"目标值"输入框
7. 输入数字，模态框不应该关闭
8. 点击模态框外的灰色背景，模态框应该关闭

**代码位置：**
- `src/components/AutoCheckItemEditor.tsx` 第 140-145 行（背景层）
- `src/components/AutoCheckItemEditor.tsx` 第 148-150 行（内容区域）
- `src/components/AutoCheckItemEditor.tsx` 第 165、172、182、189、246 行（输入框）

---

### 3. ✅ 创建自定义下拉框组件

**实现内容：**
- 创建了 `CustomSelect` 组件，替代原生 `<select>`
- 样式与应用主题一致（圆角、石色调）
- 支持键盘导航和点击外部关闭
- 选中项显示勾选图标
- 平滑的展开/收起动画

**组件特性：**
- 自定义样式，与应用主题完美融合
- 点击外部自动关闭
- 支持 `stopPropagation` 防止事件冒泡
- 响应式设计
- 无障碍支持

**验证步骤：**
1. 打开自动日课配置对话框
2. 点击"判断类型"下拉框
3. 应该看到自定义样式的下拉菜单（不是浏览器默认样式）
4. 选项应该有悬停效果
5. 选中的选项应该有蓝色背景和勾选图标
6. 点击选项后下拉框应该关闭
7. 点击"比较运算符"下拉框
8. 应该看到相同风格的下拉菜单
9. 根据判断类型，运算符选项应该动态变化

**代码位置：**
- `src/components/CustomSelect.tsx`（新文件）
- `src/components/AutoCheckItemEditor.tsx` 第 13 行（导入）
- `src/components/AutoCheckItemEditor.tsx` 第 207、217 行（使用）

---

## 新增功能

### 4. ✅ 扩展判断类型

**新增类型：**
1. 总时长（原有）
2. 最早开始时间（原有）
3. 最晚开始时间（新增）
4. 最早结束时间（原有）
5. 最晚结束时间（新增）
6. 次数（新增）

**使用场景：**
- **最早开始时间**：早起打卡（起床 ≤ 8:00）
- **最晚开始时间**：晚睡检测（睡觉 ≥ 23:00）
- **最早结束时间**：早下班（工作结束 ≤ 18:00）
- **最晚结束时间**：加班检测（工作结束 ≥ 22:00）
- **次数**：运动次数（运动 ≥ 3次）

**验证步骤：**
1. 打开自动日课配置对话框
2. 点击"判断类型"下拉框
3. 应该看到 6 个选项
4. 选择"最晚开始时间"
5. 运算符应该变为"不早于、不晚于、早于、晚于、等于"
6. 选择"次数"
7. 运算符应该变为"大于等于、小于等于、大于、小于、等于"

**代码位置：**
- `src/types.ts` 第 280 行（类型定义）
- `src/utils/autoCheckUtils.ts` 第 15-20 行（统计字段）
- `src/components/AutoCheckItemEditor.tsx` 第 42-49 行（选项定义）

---

## 完整测试流程

### 场景 1：创建学习时长自动日课

```
1. 设置 → 每日回顾 → 日课模板
2. 新建模板或编辑现有模板
3. 添加日课项
4. 选择类型：⚡ 自动
5. 点击配置按钮（⚡）
6. 配置：
   - 日课名称：学习时长达标
   - 筛选条件：#学习
   - 判断类型：总时长
   - 比较运算符：大于等于
   - 目标值：240（表示 4小时）
7. 检查规则预览是否正确
8. 保存配置
9. 保存模板
10. 打开今天的日报 → 日课标签
11. 检查自动日课是否显示
12. 检查完成状态是否正确
```

### 场景 2：创建早起自动日课

```
1. 添加日课项
2. 选择类型：⚡ 自动
3. 点击配置按钮
4. 配置：
   - 日课名称：早起
   - 筛选条件：#起床
   - 判断类型：最早开始时间
   - 比较运算符：不晚于
   - 目标值：0800（表示 8:00）
5. 检查规则预览："当 #起床 的最早开始时间 不晚于 08:00 时，自动标记为完成"
6. 保存配置
```

### 场景 3：创建运动次数自动日课

```
1. 添加日课项
2. 选择类型：⚡ 自动
3. 点击配置按钮
4. 配置：
   - 日课名称：运动打卡
   - 筛选条件：#运动
   - 判断类型：次数
   - 比较运算符：大于等于
   - 目标值：3
5. 检查规则预览："当 #运动 的次数 ≥ 3次 时，自动标记为完成"
6. 保存配置
```

---

## 检查清单

### 模态框交互
- [ ] 点击日课名称输入框不会关闭模态框
- [ ] 点击筛选条件输入框不会关闭模态框
- [ ] 点击目标值输入框不会关闭模态框
- [ ] 点击下拉框不会关闭模态框
- [ ] 点击背景层会关闭模态框
- [ ] 点击 X 按钮会关闭模态框

### 下拉框样式
- [ ] 判断类型下拉框使用自定义样式
- [ ] 比较运算符下拉框使用自定义样式
- [ ] 下拉框有圆角和阴影
- [ ] 选项有悬停效果
- [ ] 选中项有蓝色背景和勾选图标
- [ ] 下拉框有展开/收起动画

### 目标值输入
- [ ] 时长类型：输入分钟数，显示转换后的小时分钟
- [ ] 时刻类型：输入4位数字，显示转换后的时间
- [ ] 次数类型：输入数字，显示次数
- [ ] 输入框有正确的占位符提示
- [ ] 输入框下方有当前设置的提示

### 判断类型
- [ ] 总时长选项可用
- [ ] 最早开始时间选项可用
- [ ] 最晚开始时间选项可用
- [ ] 最早结束时间选项可用
- [ ] 最晚结束时间选项可用
- [ ] 次数选项可用

### 运算符动态变化
- [ ] 时长类型：显示"大于等于、小于等于、大于、小于、等于"
- [ ] 时刻类型：显示"不晚于、不早于、早于、晚于、等于"
- [ ] 次数类型：显示"大于等于、小于等于、大于、小于、等于"

### 规则预览
- [ ] 规则预览正确显示筛选条件
- [ ] 规则预览正确显示判断类型
- [ ] 规则预览正确显示运算符
- [ ] 规则预览正确显示目标值（带单位）

---

## 已知限制

1. **时刻输入**：必须输入4位数字（如 0800），不支持其他格式
2. **分钟数**：时长和时刻都以分钟为单位存储，最大值 1439（23:59）
3. **次数**：理论上无上限，但建议不超过 100

---

## 如果遇到问题

### 问题：输入框点击后模态框关闭
**检查：**
- 浏览器控制台是否有错误
- 是否使用了最新的代码
- 尝试清除浏览器缓存

### 问题：下拉框显示为原生样式
**检查：**
- CustomSelect 组件是否正确导入
- 是否有 CSS 冲突
- 浏览器控制台是否有错误

### 问题：目标值输入不正确
**检查：**
- 判断类型是否正确选择
- 输入的格式是否正确
- 查看"当前设置"提示是否正确

---

## 总结

所有三个问题都已修复：
1. ✅ 目标值统一为分钟数（内部存储）
2. ✅ 模态框点击输入框不会关闭
3. ✅ 使用自定义下拉框组件

额外改进：
- ✅ 新增 3 种判断类型
- ✅ 运算符根据类型动态变化
- ✅ 更清晰的输入提示和预览
- ✅ 更好的用户体验
