# Reaction 自定义功能

## 功能概述

在 Emoji 和 Sticker 设置页面新增了 "Reaction 图标组" 卡片，允许用户自定义 Reaction 图标。同时，系统支持在全文搜索和自定义筛选器中搜索 Reaction Emoji。

## 功能特性

### 1. 默认图标（带动画特效）

系统提供 6 个默认 Reaction 图标，每个都配有独特的动画特效：

- 🎉 - 彩带爆炸效果
- ❤️ - 爱心飘落效果
- 🔥 - 火焰上升效果
- ❄️ - 雪花飘落效果
- ✨ - 星光闪烁效果
- 🌸 - 花瓣飘落效果

### 2. 自定义图标（静态显示）

用户可以自定义这 6 个位置的图标：

- 点击"自定义 Reaction"按钮进入编辑模式
- 可以添加、编辑、删除图标
- 最多支持 6 个自定义图标
- 自定义后的图标仅支持静态显示，不具备动画特效

### 3. 临时自定义 Emoji（新增）

在使用 Reaction 选择器时，可以临时输入任意 Emoji：

- 点击 Reaction 选择器，展开 6 个预设图标
- 点击最后的"加号"按钮，弹出输入框
- 输入任意 Emoji 并确认，即可添加到记录中
- 支持输入任何 Emoji，不限于预设的 6 个
- 临时输入的 Emoji 不会保存到预设列表中

**交互方式：**
- 点击"加号"按钮后，输入框自动获得焦点
- 输入 Emoji 后按 Enter 键确认
- 按 Escape 键或点击"取消"按钮关闭输入框
- 点击"确定"按钮提交 Emoji

### 4. 恢复默认

- 使用自定义图标时，右上角会显示"恢复默认"按钮
- 点击可立即恢复到默认的 6 个带特效的图标

### 4. Reaction 搜索功能

#### 4.1 全文搜索支持 Emoji

在全局搜索中，可以直接输入 Emoji 图标进行搜索：

- 在搜索框中输入 `🌸`，系统会返回所有包含该 Reaction 的记录
- 支持搜索任何 Emoji，不限于默认的 6 个
- 搜索结果会高亮显示匹配的记录

#### 4.2 自定义筛选器支持 Reaction

在自定义筛选器中，使用 `^` 符号来搜索 Reaction：

**语法：**
```
^emoji
```

**示例：**
- `^🌸` - 筛选所有带有 🌸 Reaction 的记录
- `^🎉 OR ^❤️` - 筛选带有 🎉 或 ❤️ Reaction 的记录
- `#运动 ^💪` - 筛选标签包含"运动"且带有 💪 Reaction 的记录
- `瑜伽 ^🌸 %健康` - 筛选备注包含"瑜伽"、带有 🌸 Reaction、且领域包含"健康"的记录

**筛选器语法完整说明：**
- `#关键词` - 匹配标签名称
- `%关键词` - 匹配领域名称
- `@关键词` - 匹配待办标题
- `^emoji` - 匹配 Reaction Emoji（新增）
- `关键词` - 匹配备注全文
- `OR` - 逻辑或（连接同类型条件）
- 空格 - 逻辑与（默认）

**使用场景：**
- 快速找到所有获得特定 Reaction 的记录
- 统计某类 Reaction 的使用频率和时长
- 结合其他条件进行复杂筛选（如：找到所有运动类且获得 💪 Reaction 的记录）

## 技术实现

### 数据存储

- 自定义 Reaction 存储在 `localStorage` 中
- 键名：`lumostime_custom_reactions`
- 格式：JSON 数组，例如 `["😊", "👍", "🎯", "💪", "🌟", "🎨"]`

### 组件更新

1. **ReactionComponents.tsx**
   - 新增 `DEFAULT_REACTIONS` 常量保存默认图标
   - 新增 `getReactions()` 函数获取当前使用的图标（自定义或默认）
   - 新增 `isUsingCustomReactions()` 函数判断是否使用自定义图标
   - `ReactionPicker` 组件监听 `customReactionsChanged` 事件自动更新
   - 只有默认图标才会触发动画特效

2. **EmojiSettingsView.tsx**
   - 新增 "Reaction 图标组" 卡片
   - 支持编辑、保存、恢复默认功能
   - 显示当前使用的图标状态（默认/自定义）
   - 提供友好的提示信息

3. **filterUtils.ts**（新增）
   - 在 `ParsedFilterCondition` 接口中新增 `reactions` 字段
   - 在 `parseFilterExpression` 函数中支持解析 `^emoji` 语法
   - 在 `matchesFilter` 函数中添加 Reaction 匹配逻辑
   - 支持 OR 逻辑组合多个 Reaction 条件

4. **SearchView.tsx**（新增）
   - 在全文搜索中支持搜索 Reaction Emoji
   - 直接输入 Emoji 即可搜索相关记录
   - 搜索逻辑支持完整匹配和包含匹配

5. **FiltersSettingsView.tsx**
   - 更新筛选器创建/编辑界面的提示文本
   - 添加 `^` 符号的说明
   - 更新示例表达式

### 事件通知

当 Reaction 图标发生变化时，会触发 `customReactionsChanged` 事件：

```javascript
window.dispatchEvent(new Event('customReactionsChanged'));
```

所有使用 `ReactionPicker` 的组件会自动监听此事件并更新显示。

## 用户体验

1. **清晰的状态提示**
   - 显示当前使用的是默认图标还是自定义图标
   - 明确说明自定义后将失去动画特效

2. **直观的编辑界面**
   - 可视化显示所有图标
   - 点击图标即可编辑
   - 实时显示图标数量限制

3. **安全的操作流程**
   - 编辑时使用临时状态，点击保存才会生效
   - 可随时取消编辑
   - 一键恢复默认

## 使用场景

### 自定义 Reaction 图标
- 用户希望使用更符合个人风格的 Reaction 图标
- 用户需要特定主题的图标组（如工作、学习、生活等）
- 用户想要简化 Reaction 选择，使用更常用的图标

### Reaction 搜索与筛选
- 快速查找所有获得特定 Reaction 的记录（如：所有获得 🎉 的成就时刻）
- 统计某类 Reaction 的使用频率和总时长
- 分析不同活动类型获得的 Reaction 分布
- 创建基于 Reaction 的自定义报表（如：本月所有 💪 记录的统计）
- 结合其他筛选条件进行复杂查询（如：运动类活动中获得 ❤️ 的记录）

## 示例用例

### 用例 1：统计本月的成就时刻
创建筛选器：`^🎉`
- 快速查看所有标记为成就的记录
- 统计成就时刻的总时长和频率

### 用例 2：分析健康相关的积极记录
创建筛选器：`%健康 ^❤️ OR ^✨`
- 筛选健康领域中获得爱心或星光 Reaction 的记录
- 了解哪些健康活动带来最多积极体验

### 用例 3：查找所有瑜伽练习的高光时刻
创建筛选器：`瑜伽 ^🌸 OR ^✨`
- 筛选备注包含"瑜伽"且获得特定 Reaction 的记录
- 回顾瑜伽练习中的美好时刻

### 用例 4：全文搜索特定 Emoji
在搜索框输入：`🔥`
- 快速找到所有带有火焰 Reaction 的记录
- 无需创建筛选器，即时查看结果
