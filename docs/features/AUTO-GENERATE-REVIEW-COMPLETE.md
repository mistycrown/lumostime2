# 自动生成回顾功能 - 完成文档

## 功能概述

实现了自动生成每日、每周、每月回顾的功能。当用户开启自动生成开关后，系统会在到达设定时间时自动创建相应的回顾。

## 实现方案

### 核心设计决策

将自动生成逻辑集成到 TimelineView 的显示逻辑中，而不是使用独立的轮询机制。这样做的优势：

1. **避免重复判断**：时间轴已经有判断是否显示回顾节点的逻辑，直接复用
2. **性能优化**：不需要额外的定时器或轮询，只在渲染时检查
3. **逻辑统一**：显示节点和自动生成在同一个地方处理，易于维护

### 实现细节

#### 1. ReviewContext 状态管理

在 `src/contexts/ReviewContext.tsx` 中添加了三个自动生成开关：

```typescript
// 自动生成开关
autoGenerateDailyReview: boolean;
autoGenerateWeeklyReview: boolean;
autoGenerateMonthlyReview: boolean;
```

这些状态会持久化到 localStorage：
- `lumostime_auto_generate_daily_review`
- `lumostime_auto_generate_weekly_review`
- `lumostime_auto_generate_monthly_review`

#### 2. 偏好设置 UI

在 `src/views/settings/PreferencesSettingsView.tsx` 中添加了三个开关控件，位于各自的时间设置下方。

#### 3. TimelineView 自动生成逻辑

在 `src/views/TimelineView.tsx` 的三个 `useMemo` 中集成了自动生成：

**每日回顾**（`shouldShowReviewNode`）：
```typescript
if (shouldShow && autoGenerateDailyReview && !dailyReview) {
    setTimeout(() => {
        console.log('[AutoGenerate] 自动创建每日回顾');
        onOpenDailyReview();
    }, 0);
}
```

**每周回顾**（`weeklyReviewData`）：
```typescript
if (autoGenerateWeeklyReview && !weeklyReview) {
    setTimeout(() => {
        console.log('[AutoGenerate] 自动创建每周回顾');
        onOpenWeeklyReview(weekStart, weekEnd);
    }, 0);
}
```

**每月回顾**（`monthlyReviewData`）：
```typescript
if (autoGenerateMonthlyReview && !monthlyReview) {
    setTimeout(() => {
        console.log('[AutoGenerate] 自动创建每月回顾');
        onOpenMonthlyReview(monthStart, monthEnd);
    }, 0);
}
```

#### 4. Props 传递

在 `src/components/AppRoutes.tsx` 中：
- 从 ReviewContext 获取三个自动生成开关状态
- 将它们作为 props 传递给 TimelineView

## 触发时机

自动生成会在以下情况触发：

1. **应用启动**：如果当前时间已过设定时间且没有回顾，会自动创建
2. **日期切换**：用户切换到某一天时，会检查是否需要自动生成
3. **时间到达**：当用户在应用中，时间到达设定时间点时（通过 useMemo 重新计算）
4. **开关切换**：用户开启自动生成开关时，会立即检查并生成（如果满足条件）

## 性能优化

- **无持续轮询**：不使用 setInterval 或 setTimeout 轮询
- **事件驱动**：只在必要时（渲染、状态变化）检查
- **防重复创建**：检查是否已存在回顾，避免重复创建
- **异步执行**：使用 setTimeout(fn, 0) 避免在 render 期间调用 setState

## 文件变更

### 修改的文件

1. `src/contexts/ReviewContext.tsx`
   - 添加三个自动生成开关状态
   - 添加 localStorage 持久化

2. `src/views/settings/PreferencesSettingsView.tsx`
   - 添加三个开关 UI 控件

3. `src/views/SettingsView.tsx`
   - 传递自动生成 props 给 PreferencesSettingsView

4. `src/App.tsx`
   - 传递自动生成 props 给 SettingsView

5. `src/components/AppRoutes.tsx`
   - 从 ReviewContext 获取自动生成状态
   - 传递给 TimelineView

6. `src/views/TimelineView.tsx`
   - 在三个 useMemo 中添加自动生成逻辑
   - 接收自动生成 props

### 删除的文件

- `src/hooks/useAutoGenerateReview.ts`（不再需要独立的 hook）

## 测试建议

1. **基本功能测试**
   - 开启自动生成开关
   - 等待到达设定时间
   - 验证回顾是否自动创建

2. **边界情况测试**
   - 已存在回顾时，不应重复创建
   - 关闭开关后，不应自动创建
   - 时间未到时，不应自动创建

3. **性能测试**
   - 检查是否有不必要的重复创建
   - 验证不会影响应用性能

## 用户使用指南

1. 进入"设置" → "偏好设置"
2. 找到"每日回顾时间"、"每周回顾时间"、"每月回顾时间"设置
3. 在时间设置下方，开启"自动生成回顾"开关
4. 系统会在到达设定时间后自动创建回顾

## 注意事项

- 自动生成只在时间轴视图中触发（因为逻辑集成在 TimelineView 中）
- 如果用户长时间不打开应用，下次打开时会检查并生成所有应该生成的回顾
- 自动生成的回顾与手动创建的回顾完全相同，只是创建方式不同

## 完成日期

2026-02-14
