# 字体全局应用修复说明

## 问题

之前字体切换后，只有部分区域（如 Toast）显示新字体，其他地方仍然是默认字体。

## 原因

1. **index.html 中硬编码了字体**：`body { font-family: 'Noto Serif SC', serif; }`
2. **多个组件中硬编码了字体**：TimelineItem、CollapsibleText 等组件使用了 inline style

## 解决方案

### 1. 修改 index.html

**添加了内联脚本**，在页面加载时立即应用保存的字体：

```html
<script>
  (function() {
    const savedFont = localStorage.getItem('lumostime_font_family');
    if (savedFont && savedFont !== 'default') {
      const fontMap = {
        'lxgw-wenkai': '"LXGW WenKai", "Noto Serif SC", serif',
        'lxgw-neo-zhisong': '"LXGW Neo ZhiSong", "Noto Serif SC", serif'
      };
      const fontFamily = fontMap[savedFont];
      if (fontFamily) {
        document.body.style.fontFamily = fontFamily;
      }
    }
  })();
</script>
```

**修改了 body 样式**，使用 CSS 变量：

```css
body {
  font-family: var(--font-family, 'Noto Serif SC', serif);
}
```

### 2. 移除组件中的硬编码字体

修改了以下组件，移除了 inline style 中的 `fontFamily`：

- ✅ `src/components/TimelineItem.tsx` - 标题和评论
- ✅ `src/components/CollapsibleText.tsx` - 可折叠文本

### 3. 保留特殊设计的字体

以下组件保留了特殊字体（因为是特定的设计需求）：

- `src/components/TimePalCard.tsx` - 使用 Playfair Display 作为装饰字体
- `src/views/ShareView.tsx` - 分享卡片的特殊字体设计

## 工作原理

### 字体应用流程

```
页面加载
    ↓
index.html 内联脚本读取 localStorage
    ↓
立即应用保存的字体到 body
    ↓
React 应用启动
    ↓
useAppInitialization 调用 fontService.initializeFont()
    ↓
再次确认字体应用（双保险）
    ↓
所有组件继承 body 的字体
```

### 字体切换流程

```
用户在 FontSelector 中选择字体
    ↓
fontService.setFont(fontId)
    ↓
更新 localStorage
    ↓
设置 document.body.style.fontFamily
    ↓
设置 CSS 变量 --font-family
    ↓
所有组件立即更新（继承 body 字体）
```

## 测试

现在切换字体后，应该看到：

✅ 整个应用的文字都会立即改变
✅ 包括：标题、正文、按钮、输入框等所有文本
✅ 刷新页面后字体设置保持
✅ 没有字体闪烁（FOUC）

## 注意事项

### 添加新字体时

如果添加新字体，需要在 `index.html` 的内联脚本中更新 `fontMap`：

```javascript
const fontMap = {
  'lxgw-wenkai': '"LXGW WenKai", "Noto Serif SC", serif',
  'lxgw-neo-zhisong': '"LXGW Neo ZhiSong", "Noto Serif SC", serif',
  'your-new-font': '"Your Font Name", "Noto Serif SC", serif'  // 添加这里
};
```

### 如果某个组件需要特殊字体

如果某个组件确实需要使用特殊字体（如装饰性字体），可以保留 inline style：

```tsx
<div style={{ fontFamily: '"Special Font", serif' }}>
  特殊文字
</div>
```

但大部分情况下，应该让组件继承全局字体。

## 工程量

实际修改：
- ✅ 1 个 HTML 文件（index.html）
- ✅ 2 个组件文件（TimelineItem、CollapsibleText）
- ✅ 总共约 10 分钟工作量

**结论**：工程量很小，主要是移除硬编码的字体样式。

---

**修复完成时间**: 2026-02-14
**影响范围**: 全局字体应用
**测试状态**: 待测试
