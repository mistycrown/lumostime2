# 字体问题最终修复

## 根本原因

**Tailwind CSS 配置硬编码了字体！**

你的应用大量使用了 `font-serif` 这个 Tailwind 类，而 Tailwind 配置中写死了：

```javascript
fontFamily: {
  serif: ['"Noto Serif SC"', 'serif'],  // ❌ 硬编码！
}
```

这导致所有使用 `font-serif` 类的元素都强制使用 Noto Serif SC，无法切换。

## 解决方案

### 1. 修改 Tailwind 配置，使用 CSS 变量

```javascript
tailwind.config = {
  theme: {
    extend: {
      fontFamily: {
        serif: ['var(--font-family)', '"Noto Serif SC"', 'serif'],  // ✅ 使用变量
        sans: ['Inter', 'sans-serif'],
      }
    }
  }
}
```

### 2. 在页面加载时立即设置 CSS 变量

在 Tailwind 加载**之前**，通过内联脚本设置 `--font-family`：

```javascript
<script>
  (function() {
    const savedFont = localStorage.getItem('lumostime_font_family');
    const fontMap = {
      'default': '"Noto Serif SC", serif',
      'lxgw-wenkai': '"LXGW WenKai", "Noto Serif SC", serif',
      'lxgw-neo-zhisong': '"LXGW Neo ZhiSong", "Noto Serif SC", serif'
    };
    const fontFamily = fontMap[savedFont] || fontMap['default'];
    document.documentElement.style.setProperty('--font-family', fontFamily);
  })();
</script>
```

### 3. body 样式使用 CSS 变量

```css
body {
  font-family: var(--font-family, 'Noto Serif SC', serif);
}
```

## 工作原理

```
页面加载
    ↓
内联脚本读取 localStorage
    ↓
设置 CSS 变量 --font-family
    ↓
Tailwind CSS 加载
    ↓
Tailwind 的 font-serif 使用 var(--font-family)
    ↓
所有使用 font-serif 类的元素都应用正确的字体
    ↓
React 应用启动
    ↓
fontService 再次确认字体设置
```

## 现在应该工作了！

刷新页面后，你应该看到：

✅ 整个应用的字体都是你选择的字体
✅ 包括所有使用 `font-serif` 类的元素
✅ 刷新页面后字体保持
✅ 切换字体立即生效

## 测试步骤

1. **清除浏览器缓存**（重要！）
   - 按 Ctrl+Shift+Delete
   - 或者硬刷新：Ctrl+Shift+R

2. **打开浏览器控制台**（F12）
   - 应该看到：`[Font Init] Applied font: lxgw-wenkai → "LXGW WenKai", "Noto Serif SC", serif`

3. **检查 CSS 变量**
   - 在控制台输入：`getComputedStyle(document.documentElement).getPropertyValue('--font-family')`
   - 应该看到你选择的字体

4. **切换字体**
   - 进入"投喂功能" → "字体" Tab
   - 切换不同字体
   - 观察整个页面的文字变化

## 如果还是不行

1. **检查控制台是否有错误**
2. **确认字体文件已加载**：
   - Network 标签 → 搜索 `.woff2`
   - 应该看到 200 状态码
3. **检查 localStorage**：
   - Application 标签 → Local Storage
   - 查看 `lumostime_font_family` 的值

---

**修复完成时间**: 2026-02-14
**关键问题**: Tailwind CSS 配置硬编码
**解决方案**: 使用 CSS 变量
